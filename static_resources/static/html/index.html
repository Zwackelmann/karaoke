<html>
    <head>
        <title>Karaoke</title>
        <script type="text/javascript" src="../js/jquery-3.1.0.min.js"></script>
        <script type="text/javascript">
            var textQueryUrl = "https://ck0at5btn3.execute-api.eu-central-1.amazonaws.com/prod/query/text";
            var artistQueryUrl = "https://ck0at5btn3.execute-api.eu-central-1.amazonaws.com/prod/query/artist";
            var songQueryUrl = "https://ck0at5btn3.execute-api.eu-central-1.amazonaws.com/prod/query/song";

            var spotifyResultsLimit = 3;

            var minWaitTime = 750; // min wait time between two text queries
            var timeoutRunning = false; // if a request is pending right now
            var lastRequestDate = 0; // last timestamp of sent request

            function queryAuthorFun(artist) {
                return function() {
                    queryAuthor(artist)
                }
            }

            function queryAuthor(artist) {
                var artistResultDiv = $('#artist_result');

                $.ajax({
                    'type': 'POST',
                    'url': artistQueryUrl,
                    'contentType': 'application/json',
                    'data': JSON.stringify({'artist_id': artist['id']}),
                    'dataType': 'json',
                    'success': function(songs) {
                        artistResultDiv.empty();

                        if(songs.length > 0) {
                            var numSongs = songs.length;
                            for(var i=0; i<numSongs; i++) {
                                var song = songs[i];
                                var songButton = $("<button class='result_item'>");
                                songButton.append($("<p class='song_title'>").append(song["song_title"]));
                                songButton.append($("<p class='song_artist'>").append(artist["name"]));
                                songButton.click(querySongFun(song['song_id']));
                                artistResultDiv.append(songButton);
                            }
                        }
                    }
                })
            }

            function querySongFun(songId) {
                return function() {
                    querySong(songId)
                }
            }

            function querySong(songId) {
                var songResultDiv = $('#song_result');

                $.ajax({
                    'type': 'POST',
                    'url': songQueryUrl,
                    'contentType': 'application/json',
                    'data': JSON.stringify({'song_id': songId, 'limit': spotifyResultsLimit}),
                    'dataType': 'json',
                    'success': function(results) {
                        songResultDiv.empty();
                        console.log(results);

                        var numResults = results.length;
                        for(var i=0; i<numResults; i++) {
                            var result = results[i];

                            var songDl = $("<dl>");
                            songDl.append($("<dt>").append("artists"));
                            songDl.append($("<dd>").append(result["artists"].join(", ")));
                            songDl.append($("<dt>").append("song_name"));
                            songDl.append($("<dd>").append(result["song_name"]));
                            songDl.append($("<dt>").append("spotify_link"));
                            songDl.append($("<dd>").append(result["spotify_link"]));
                            songDl.append($("<dt>").append("preview_url"));
                            songDl.append($("<dd>").append(result["preview_url"]));
                            songDl.append($("<dt>").append("uri"));
                            songDl.append($("<dd>").append(result["uri"]));
                            songDl.append($("<dt>").append("duration"));
                            songDl.append($("<dd>").append(result["duration"]));

                            songResultDiv.append(songDl);
                        }
                    }
                })
            }

            function queryText() {
                var textQuery = $('#text_query_input').val();
                if(textQuery.length < 3) {
                    return
                }

                var textSearchResultDiv = $('#text_search_result');

                if(!timeoutRunning) {
                    var requestTimeDiff = Date.now()-lastRequestDate;
                    var waitTime = Math.max(minWaitTime-requestTimeDiff, 1);
                    lastRequestDate = Date.now();

                    timeoutRunning = true;
                    setTimeout(function () {
                        timeoutRunning = false;
                        $.ajax({
                            'type': 'POST',
                            'url': textQueryUrl,
                            'contentType': 'application/json',
                            'data': JSON.stringify({'q': textQuery}),
                            'dataType': 'json',
                            'success': function (data) {
                                var artists = data['artists'];
                                var songs = data['songs'];

                                textSearchResultDiv.empty();

                                if (artists.length > 0) {
                                    var numArtists = artists.length;
                                    var artistParagraph = $("<p></p>");
                                    artistParagraph.append("<h3>Artist results</h3>");
                                    for (var i = 0; i < numArtists; i++) {
                                        var artist = artists[i];

                                        var artistButton = $("<button class='result_item'>");
                                        artistButton.append($("<p class='artist'>").append(artist["artist_name"]));
                                        artistButton.click(queryAuthorFun({'id': artist['artist_id'], 'name': artist['artist_name']}));
                                        artistParagraph.append(artistButton);
                                    }
                                    textSearchResultDiv.append(artistParagraph)
                                }

                                if (songs.length > 0) {
                                    var numSongs = songs.length;
                                    var songParagraph = $("<p></p>");
                                    songParagraph.append("<h3>Song results</h3>");
                                    for (var i = 0; i < numSongs; i++) {
                                        var song = songs[i];

                                        var songButton = $("<button class='result_item'>");
                                        songButton.append($("<p class='song_title'>").append(song["song_title"]));
                                        songButton.append($("<p class='song_artist'>").append(song["artist_name"]));
                                        songButton.click(querySongFun(song['song_id']));
                                        songParagraph.append(songButton);
                                    }
                                    textSearchResultDiv.append(songParagraph)
                                }
                            }
                        })
                    }, waitTime)
                }
            }
        </script>
        <style>
            @import url(https://fonts.googleapis.com/css?family=Raleway:400,600);
            .result_item {
                font-family: 'Raleway', Arial, sans-serif;
                border: none;
                background-color: #667273;
                border-radius: 3px;
                color: #ffffff;
                cursor: pointer;
                padding: 0px 40px;
                display: inline-block;
                margin: 15px 30px;
                text-transform: uppercase;
                line-height: 2.7em;
                font-weight: 600;
                outline: none;
                position: relative;
                -webkit-transition: all 0.3s;
                transition: all 0.3s;
            }
            .song_artist {
                padding: 0 0;
                margin: 0 0;
                font-weight: 300;
                font-size: 0.75em;
            }
            .song_title {
                padding: 0 0;
                margin: 0 0;
                font-weight: 600;
                font-size: 1.0em;
            }
            .artist {
                padding: 0 0;
                margin: 0 0;
                font-weight: 600;
                font-size: 1.0em;
            }
        </style>
    </head>

    <body>
        <h1>Karaoke Yay!</h1>
        <input oninput="queryText()" type="text" id="text_query_input" />
        <h2>Text Search Result</h2>
        <div id="text_search_result"></div>
        <h2>Artist Result</h2>
        <div id="artist_result"></div>
        <h2>Song Result</h2>
        <div id="song_result"></div>
    </body>
</html>